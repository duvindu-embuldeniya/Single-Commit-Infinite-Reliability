âœ…Application Side..................................................................................................//
s3 configuration
django-environ setup
D->F | Allowed Hosts (EC2 IP + app.duvindu.org + duvindu.org + www.duvindu.org, localhost, 127.0.0.1) 
pip gunicorn
rq.txt creation in inside
Docker File






âœ…EC2 SetUp Part(1).................................................................................................//
ğŸŸ¢update & upgrade

ğŸŸ¢Java Installation
sudo apt install fontconfig openjdk-21-jre
sudo apt install openjdk-21-jdk-headless


export PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"

sudo nano /etc/environment

JAVA_HOME="/usr/lib/jvm/java-21-openjdk-amd64"
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:$JAVA_HOME/bin"  (ctr + o , enter, ctr + x)

source /etc/environment


echo $JAVA_HOME
</usr/lib/jvm/java-21-openjdk-amd64>

javac
<snippet>

ğŸŸ¢Jenkins installation & 8080 Security Grp

ğŸŸ¢lnstall Nginx
sudo apt-get update
sudo apt-get install nginx
sudo service nginx status








âœ…Cloudfair Part.................................................................................................//
ğŸŸ¢add domain from Route53 to Cloudfair
ğŸŸ¢use two new nameservers generated by cloudfair as route53 nameservers within registered domain (remove existing 4 and save for later)

ğŸŸ¢create subdomains (app, jenkins to EC2 Public Ip)
ğŸŸ¢overview -> Full | Edge Certification -> HTTPS Disabled (currently)






âœ…EC2 SetUp Part(2)...............................................................................................//
sudoapt install python3-pip
sudo apt install python3.12-venv
sudo apt install nginx curl
python3 -m venv venv
ssh-keygen -t rsa
cat /home/ubuntu/.ssh/id_rsa.pub
clone via ssh url of repo
sudo mv <project> /var/www/
cp env.sample .env
nano .env
source ~/venv/bin/activate
pip install -r requirements.txt
gunicorn --bind 0.0.0.0:8000 simply.wsgi | 8000 Security Grp



âœ….............................................................................................................//
deactivate
cd
documentation steps follow

ğŸŸ¢///////////////////////////////////////////////////////////////////////////////////////////////////////////////
[Unit]
Description=gunicorn daemon
Requires=gunicorn.socket
After=network.target

[Service]
User=ubuntu
Group=www-data
WorkingDirectory=/var/www/<project>
ExecStart=/home/ubuntu/venv/bin/gunicorn \
          --access-logfile - \
          --workers 3 \
          --bind unix:/run/gunicorn.sock \
          simply.wsgi:application

[Install]
WantedBy=multi-user.target


ğŸŸ¢
# app.duvindu.org â†’ App's default page.../////////////////////////////////////////////////////////////////////////
server {
    listen 80;
    server_name app.duvindu.org;

    location = /favicon.ico { access_log off; log_not_found off; }
    
    location / {
        include proxy_params;
        proxy_pass http://unix:/run/gunicorn.sock;
    }
}


ğŸŸ¢
# jenkins.duvindu.org â†’ Jenkins (8080).../////////////////////////////////////////////////////////////////////////
server {
    listen 80;
    server_name jenkins.duvindu.org;

    location / {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}





âœ…Manual Redeployment test.....................................................................................//
venv activate
cd to project dir
git pull
deactivate
sudo systemctl restart gunicorn
sudo systemctl reload nginx


âœ…Install SSL...................................................................................................//
1. lnstall Certbot and Nginx Plugin
sudo apt install certbot python3-certbot-nginx -y


2.0btain and Install SSL Certificate
sudo certbot --nginx -d jenkins.duvindu.org

ğŸŸ¢Cloudfair settings change





âœ…Jenkins + GitLab ...............................................................................................//
ğŸŸ¢make keys as Jenkins user
ssh-keygen -t rsa -b 4096 -C "jenkins-deploy"


ğŸŸ¢Copy the PRIVATE KEY
cat ~/.ssh/id_rsa


---Add this private key to Jenkins Credentials---
ğŸŸ¢Go to
Jenkins Dashboard â†’ Manage Jenkins â†’ Credentials


ğŸŸ¢Select "Global" credentials store
(global) â†’ Add Credentials


ğŸŸ¢Choose credential type
Kind: SSH Username with private key
Username: jenkins 


ğŸŸ¢Under Private Key, select ->Enter directly
--Paste the entire private key from your EC2(B):--
-----BEGIN OPENSSH PRIVATE KEY-----
...your key here...
-----END OPENSSH PRIVATE KEY-----


ğŸŸ¢Give it an ID--
ec2-jenkins-key


stage('Deploy') {
    steps {
        sshagent(['ec2-jenkins-key']) {
            sh 'ssh ubuntu@<EC2_A_PUBLIC_IP> -o StrictHostKeyChecking=no "bash /var/www/project5/scripts/deploy.sh"'
        }
    }
}



ğŸŸ¢Copy the public KEY to EC2(A)
cat ~/.ssh/id_rsa.pub


ğŸŸ¢Set correct permissions ON EC2(A)
mkdir -p ~/.ssh
nano ~/.ssh/authorized_keys
chmod 700 ~/.ssh
chmod 600 ~/.ssh/authorized_keys






âœ…Docker Install to EC2.............................................................................................//
ğŸŸ¢install via documentation steps
ğŸŸ¢give jenkins user to run docker commands permissions

sudo usermod -aG docker jenkins
sudo systemctl restart jenkins
sudo systemctl status jenkins
sudo -u jenkins docker --version



âœ…Install AWS CLI to EC2............................................................................................//
curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"


sudo apt update
sudo apt install unzip -y


unzip awscliv2.zip


sudo ./aws/install


//test.................//
aws --version





âœ…(EC2 + Jenkins) from AWS Console side..............................................................................//
ğŸŸ¢ Step 1: Create IAM Role (AWS Console)

Open AWS Console â†’ IAM
Click Roles â†’ Create role
Trusted entity â†’ AWS service
Use case â†’ EC2
Click Next


ğŸŸ¢ Step 2: Attach Permissions (ECR)

Attach ONE of these:
Simple (recommended for now)
AmazonEC2ContainerRegistryFullAccess
Click Next


ğŸŸ¢ Step 3: Name the Role

Role name: JenkinsECRRole
Create role


ğŸŸ¢ Step 4: Attach Role to Jenkins EC2

Go to EC2 â†’ Instances
Select your Jenkins EC2 instance
Click Actions â†’ Security â†’ Modify IAM role
Choose JenkinsECRRole
Save


ğŸŸ¢ Step 5: Verify from EC2 (IMPORTANT)

SSH into your Jenkins EC2 and run:
aws sts get-caller-identity

âœ… You MUST see output like:
{
  "Account": "047719622998",
  "Arn": "arn:aws:sts::047719622998:assumed-role/JenkinsECRRole/i-xxxx",
  "UserId": "AROA..."
}

âœ”ï¸ If you see this â†’ YOU ARE DONE

